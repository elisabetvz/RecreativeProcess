document.documentElement.className += 'hidden';

!function ($) {

    $.fn.visible = function(partial) {
        var $t            = $(this),
            $w            = $(window),
            viewTop       = $w.scrollTop(),
            viewBottom    = viewTop + $w.height(),
            _top          = $t.offset().top,
            _bottom       = _top + $t.height(),
            compareTop    = partial === true ? _bottom : _top,
            compareBottom = partial === true ? _top : _bottom;

        return (compareBottom <= viewBottom);
    };

    $.fn.hasGoneBy = function() {
        var elementTop = $(this).offset().top;
        var elementBottom = elementTop + $(this).outerHeight();
        var viewportTop = $(window).scrollTop();
        var viewportBottom = viewportTop + $(window).height();
        return elementTop < (viewportBottom - 200);
    };

// ---------------------------------------------------------------------------------------------------------------------

    $(function() {

        var $window = $(window);
        var $html = $('html');
        var $body = $('body');
        var $header = $('#header');
        var $footer = $('#footer');
        var $articles = $('.mod_article').not('.first');
        var $wrappers = $('.mod_wrapper').not('#background');
        var $cookiebanner = $('#cookiebanner');
        var windowWidth, windowHeight;

// ---------------------------------------------------------------------------------------------------------------------
// COOKIEBANNER
// ---------------------------------------------------------------------------------------------------------------------

        $cookiebanner.find('.show_details').on('click', function() {
            $cookiebanner.find('.details').slideToggle();
        });

        if(Cookies.get('CookieConsent') === 'Necessary') {
            //console.log('necessary_cookies_are_set');
            $cookiebanner.remove();
        } else if(Cookies.get('CookieConsent') === 'All') {
            //console.log('all_cookies_are_set');
            $cookiebanner.remove();
            acceptGoogle();
        } else {
            //console.log('cookies_are_not_set');
            $body.addClass('show_cookiebanner');
        }

        $cookiebanner.find('.accept_necessary_cookies').on('click', function(e) {
            Cookies.set('CookieConsent', 'Necessary', { expires: 365 });
            $body.removeClass('show_cookiebanner');
            e.stopPropagation();
            return false;
        });

        $cookiebanner.find('.accept_cookies').on('click', function(e) {
            Cookies.set('CookieConsent', 'All', { expires: 365 });
            acceptGoogle();
            $body.removeClass('show_cookiebanner');
            e.stopPropagation();
            return false;
        });

        function deleteCookies() {
            var cookies = document.cookie.split("; ");
            for (var c = 0; c < cookies.length; c++) {
                var d = window.location.hostname.split(".");
                while (d.length > 0) {
                    var cookieBase = encodeURIComponent(cookies[c].split(";")[0].split("=")[0]) + '=; expires=Thu, 01-Jan-1970 00:00:01 GMT; domain=' + d.join('.') + ' ;path=';
                    var p = location.pathname.split('/');
                    document.cookie = cookieBase + '/';
                    while (p.length > 0) {
                        document.cookie = cookieBase + p.join('/');
                        p.pop();
                    }
                    d.shift();
                }
            }
        }

        $('#removecookies').on('click', function(e) {

            if(Cookies.get('CookieConsent') === 'Necessary' || Cookies.get('CookieConsent') === 'All') {
                Cookies.remove('CookieConsent');
                deleteCookies();
            }
            $('#removecookies').remove();
            return false;
        });

// ---------------------------------------------------------------------------------------------------------------------
// LOADER
// ---------------------------------------------------------------------------------------------------------------------

        var $bar;

        $body.prepend('<div id="loader"><div id="progress"></div></div>');
        $bar = $('#progress');

        function imagesLoaded() {
            $body.imagesLoaded({
                background: true
            }).always(function() {
                $bar.css('width', '100%');
                $('#progress').slideUp(300, function() {
                    $('html').removeClass('hidden');
                    $('#loader').remove();
                });
            }).progress( function(instance, image) {
                if(image.isLoaded) {
/*
                    var w = $(image.img).width();
                    var h = $(image.img).height();
                    var t;

                    if(w > h) {
                        t = 'landscape';
                    } else if(h > w) {
                        t = 'portrait';
                    } else if(w == h) {
                        t = 'square';
                    }

                    $(image.img).addClass(t);
*/
                    $(image.img).addClass('loaded');
                    var countLoadedImages = $body.find('img.loaded').length;
                    var width = 100 * (countLoadedImages / $body.find('img').length) + '%';
                    $bar.css('width', width);
                }
            });
        }

        imagesLoaded();

// ---------------------------------------------------------------------------------------------------------------------
// FILTER
// ---------------------------------------------------------------------------------------------------------------------

        var scan = false; // INITIAL INDEX SET => ID

        function setIndex() {

            var count = 0; // ITERATING INDEX 1-6

            $('.ce_projects').find('.item').each(function(index) {
                if(!$(this).hasClass('blank')) {

                    if(scan === false) {
                        $(this).data('initial-index', index);
                        $(this).attr('id', index+1);
                    }

                    if(count >= 6) {
                        count = 1;
                    } else {
                        count++;
                        // CASE FOR FALLBACK IMAGE
                        if(count === 2 || count === 4) {
                            $(this).find('img.lazy').attr('src', $(this).find('img.lazy').data('src'));
                            $(this).find('img.lazy').removeClass('lazy');
                        }
                    }
                    $(this).attr('alt', count);
                }
            });

            scan = true;
        }

        if(($body.hasClass('startseite') || $body.hasClass('projekt')) && $('.ce_projects').length > 0) {
            setIndex();
        }

        if($('.ce_filter').length > 0) {

            var target, projects;

            // SET INDEX
            setIndex();

            $('.ce_filter li').on('click', function() {

                // SET STATE
                $('.ce_filter li').removeClass('active');
                $(this).addClass('active');

                // GET FILTER
                target = $(this).data('filter');

                // RESET FILTER
                if(projects) {
                    $(projects).appendTo('.ce_projects').each(function() {
                        var initialIndex = $(this).data('initial-index');
                        $('.ce_projects').find('.item').eq(initialIndex).before(this);
                    });
                    projects = null;
                }

                // APPEND FILTER
                if (target !== '*') {
                    projects = $('.ce_projects').find('.item').not('.'+target).not('.blank').detach();
                }

                // SET INDEX
                setIndex();
            });
        }

// ---------------------------------------------------------------------------------------------------------------------
// ISOTOPE
// ---------------------------------------------------------------------------------------------------------------------

        if($('.isotope').length > 0) {

            $('.isotope').append('<div class="sizer"></div>');

            var $grid = $('.isotope').isotope({
                masonry: {
                    columnWidth: '.sizer',
                    horizontalOrder: true
                },
                itemSelector: '.layout_latest',
                layoutMode: 'masonry',
                percentPosition: true,
                transitionDuration: 0
            });

            // FIX POSITIONS ON SLOW
            // LOADING FOR GRID ITEMS

            $grid.imagesLoaded().progress( function() {
                $grid.isotope('layout');
            });
        }

// ---------------------------------------------------------------------------------------------------------------------
// SECTION NUMBER
// ---------------------------------------------------------------------------------------------------------------------

        $articles.each(function(index) {
            $(this).data('number', index);
        });

        $wrappers.each(function(index) {
            $(this).data('number', index);
        });

// ---------------------------------------------------------------------------------------------------------------------
// WINDOW SCROLLING
// ---------------------------------------------------------------------------------------------------------------------

        $(window).on('scroll', function () {

            if($('.invert_page').length > 0) {
                if ($('.invert_page').hasGoneBy()) {
                    $body.addClass('inverted');
                } else {
                    $body.removeClass('inverted');
                }
            }

            // SECTION

            $articles.each(function(index) {
                if($(this).visible(true)) {
                    if($(this).data('number') < 10) {

                        var num = $(this).data('number');

                        if(num < 1) {
                            num = 1;
                        }

                        $('.section').text('0'+num);
                    } else {
                        $('.section').text($(this).data('number'));
                    }
                }
            });

            $wrappers.each(function(index) {
                if($(this).visible(true)) {
                    if($(this).data('number') < 10) {

                        var num = $(this).data('number');

                        if(num < 1) {
                            num = 1;
                        }

                        $('.section').text('0'+num);
                    } else {
                        $('.section').text($(this).data('number'));
                    }

                }
            });

            if($footer.visible(true)) {
                $('.section').fadeOut(100);
            } else {
                $('.section').fadeIn(100);
            }

            if($body.hasClass('projekt')) {
                if($footer.visible(true)) {
                    $('.back_to_projects').fadeOut(100);
                } else {
                    $('.back_to_projects').fadeIn(100);
                }
            }

            // PROGRESS BAR

            var winScroll = document.body.scrollTop || document.documentElement.scrollTop;
            var height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
            var scrolled = (winScroll / height) * 100;
            document.getElementById("progressbar").style.width = scrolled + "%";

            // ROLLER

            if($('.ce_roller').length > 0) {
                $('.ce_roller img').css({
                    'transform': 'rotate(' + $(document).scrollTop() * 0.5 + 'deg)'
                });
            }

            // SCROLLINDICATOR

            if($('.scrollindicator').length > 0) {

                if(winScroll > 200) {
                    $('.scrollindicator').hide();
                    $('.section').removeClass('hide');
                } else {
                    $('.scrollindicator').show();
                    $('.section').addClass('hide');
                }
            }

        });

        $(window).scroll();

// ---------------------------------------------------------------------------------------------------------------------
// WINDOW RESIZE
// ---------------------------------------------------------------------------------------------------------------------

        $window.resize(function() {

            // WINDOW
            windowWidth = $window.width();
            windowHeight = $window.height();

            if(windowWidth <= 760 && $('.ce_projects').length > 0) {

                $('.ce_projects').find('.item:nth-child(3n+3)').each(function(index) {
                    if (!$(this).hasClass('blank')) {
                        $(this).find('img.lazy').attr('src', $(this).find('img.lazy').data('src'));
                        $(this).find('img.lazy').removeClass('lazy');
                    }
                });
            }
        });

        $window.resize();

// ---------------------------------------------------------------------------------------------------------------------
// ANCHOR SCROLLING
// ---------------------------------------------------------------------------------------------------------------------

        $('a[href*="#"]')
            .not('[href="#"]')
            .not('[href="#0"]')
            .click(function(event) {
                if (location.pathname.replace(/^\//, '') == this.pathname.replace(/^\//, '')
                    &&
                    location.hostname == this.hostname) {

                    var target = $(this.hash);
                    target = target.length ? target : $('[name=' + this.hash.slice(1) + ']');
                    if (target.length) {
                        event.preventDefault();
                        $('html, body').animate({
                            scrollTop: target.offset().top
                        }, 1000, function() {
                            return false;
                        });
                    }
                }
            });

// ---------------------------------------------------------------------------------------------------------------------
// COLUMNS
// ---------------------------------------------------------------------------------------------------------------------

        $('.empty').each(function() {
            $(this).closest('.column').addClass('hide_on_mobile');
        });

// ---------------------------------------------------------------------------------------------------------------------
// CE_FORM
// ---------------------------------------------------------------------------------------------------------------------

        $('button.submit').append('<i class="fal fa-long-arrow-right"></i>');

// ---------------------------------------------------------------------------------------------------------------------
// HAMBURGER
// ---------------------------------------------------------------------------------------------------------------------

        $('.hamburger').on('click', function(e) {
            $body.toggleClass('show_navigation');
        });

// ---------------------------------------------------------------------------------------------------------------------
// MOBILE
// ---------------------------------------------------------------------------------------------------------------------

        if( /Android|webOS|iPhone|iPad|iPod|Opera Mini/i.test(navigator.userAgent) ) {
            $body.addClass('is_mobile_device');
        } else {
            $body.addClass('is_not_mobile_device');
        }

// ---------------------------------------------------------------------------------------------------------------------
// CURSOR
// ---------------------------------------------------------------------------------------------------------------------
/*
        $body.append('<div id="cursor"></div>');
        var $cursor = $('#cursor');
        var mouseX = 0;
        var mouseY = 0;
        var cursorX = 0;
        var cursorY = 0;
        var speed = 0.2;
        var offset;
        var elementX = 0;
        var elementY = 0;

        // ELEMENTS

        $('a, .hamburger')
            .mouseenter(function() {
                $cursor.addClass('hover');
            })
            .mouseleave(function() {
                $cursor.removeClass('hover');
            });

        // POSITION

        function animate() {
            var distX = mouseX - cursorX;
            var distY = mouseY - cursorY;
            cursorX = cursorX + (distX * speed);
            cursorY = cursorY + (distY * speed);

            $cursor.css({
                'top': cursorY + 'px',
                'left': cursorX + 'px'
            });

            requestAnimationFrame(animate);
        } animate();

        $html.mousemove(function(event) {

            if($body.hasClass('is_not_mobile_device')) {

                $cursor.css({
                    'opacity': 1
                });

                mouseX = event.pageX;
                mouseY = event.pageY;
            }

        });
*/
// ---------------------------------------------------------------------------------------------------------------------

    });
}(jQuery);